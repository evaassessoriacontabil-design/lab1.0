<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Laborat√≥rio Cont√°bil ‚Äî v6.12 Premium</title>

<style>
  /* Base / Layout */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0a0a0a;color:#fff;font-family:Arial, system-ui, -apple-system}
  .screen{display:none;position:relative;width:100vw;height:100vh;overflow:hidden}
  @supports (height:100svh){.screen{height:100svh}}
  .show{display:block}
  .wrap{position:relative;z-index:2;display:flex;align-items:center;justify-content:flex-end;height:100%;padding:5%}

  /* Fundo responsivo de alta qualidade */
  .bg{position:absolute;inset:0;pointer-events:none;background-position:center;background-repeat:no-repeat;background-size:cover}
  @media (max-aspect-ratio: 9/16), (min-aspect-ratio: 21/9){
    .bg{background-size:contain;background-color:#000}
  }

  /* Bot√µes / Cart√µes */
  .btn{appearance:none;-webkit-appearance:none;background:#ff2d2d;color:#fff;border:0;border-radius:12px;padding:16px 28px;font-weight:700;font-size:28px;min-width:240px;cursor:pointer;text-decoration:none;display:inline-block;text-align:center}
  .btn-secondary{background:#2a2a2a;color:#fff;border:0;border-radius:12px;padding:16px 28px;font-weight:700;font-size:22px;min-width:220px;cursor:pointer}
  .btn-cta{background:#ff2d2d;color:#fff;border:0;border-radius:12px;padding:16px 28px;font-weight:700;font-size:22px;min-width:220px;cursor:pointer}
  .quiz-card{background:#fff;color:#000;border-radius:14px;padding:22px;max-width:640px;box-shadow:0 8px 22px rgba(0,0,0,.35)}

  /* Quiz √† direita + cabe√ßalho fora do card */
  #quiz .wrap{justify-content:flex-end;align-items:center;padding-right:8%}
  .quiz-col{display:flex;flex-direction:column;align-items:flex-end;gap:12px;max-width:720px;width:100%}
  .quiz-head{color:#fff;font-weight:900;font-size:clamp(22px,3.4vw,38px);letter-spacing:.2px;text-align:right;line-height:1.15}
  .quiz-head .accent{display:inline-block;background:#ff2d2d;padding:4px 10px;border-radius:999px;font-size:.65em;margin-left:10px;vertical-align:middle}
  .quiz-top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px}
  .counter{background:#111;color:#fff;padding:6px 10px;border-radius:999px;font-weight:700;font-size:16px;min-width:66px;text-align:center}
  #qtext{font-size:clamp(22px,3vw,34px);font-weight:800;margin:12px 0 16px}
  .opt{display:block;width:100%;margin:8px 0;padding:14px;background:#eee;border:0;border-radius:10px;text-align:left;font-size:clamp(16px,2vw,20px);cursor:pointer}

  /* Resultado */
  #result .wrap{flex-direction:column;justify-content:center;align-items:center;padding:5%}
  .actions{text-align:left;margin:16px 0;padding-left:18px}
  .actions li{margin:8px 0}
  .btn-row{display:flex;gap:20px;margin-top:20px;justify-content:center;flex-wrap:wrap}

  /* G√™nero */
  #gender .wrap{flex-direction:column;align-items:flex-end;justify-content:center;gap:18px}

  /* Rodap√© discreto (jur√≠dico) */
  footer{position:fixed;left:0;right:0;bottom:6px;text-align:center;font-size:12px;color:#999}
  footer a{color:#bbb;text-decoration:none}
  footer a:hover{text-decoration:underline}

  /* Mobile */
  @media (max-width:480px){
    .btn{font-size:20px;min-width:200px}
    .btn-cta,.btn-secondary{font-size:18px;min-width:180px}
    .quiz-card{max-width:92vw;padding:18px}
    #quiz .wrap{padding-right:4%}
    .quiz-col{max-width:92vw}
  }
</style>
</head>
<body>

<!-- CAPA -->
<section id="cover" class="screen show">
  <div class="bg" style="background-image:url('images/capa.png')"></div>
  <div class="wrap" style="align-items:flex-end;justify-content:flex-end">
    <button class="btn" onclick="go('intro')">üéÆ VAMOS JOGAR</button>
  </div>
</section>

<!-- INTRODU√á√ÉO -->
<section id="intro" class="screen">
  <div class="bg" style="background-image:url('images/intro.png')"></div>
  <div class="wrap" style="align-items:flex-end;justify-content:flex-end">
    <!-- Mercado Pago ‚Äî abre checkout em nova aba; ESTA aba vai para /acesso.html -->
    <button class="btn" id="ativarBtn" type="button"
      onclick="return payAndValidate('https://www.mercadopago.com.br/checkout/v1/redirect?pref_id=2484262675-2ba4593b-48de-448d-a7ab-e1756a222c26');">
      ATIVAR JOGO ‚Äì R$29,90
    </button>
  </div>
</section>

<!-- G√äNERO -->
<section id="gender" class="screen">
  <div class="bg" style="background-image:url('images/genero.png')"></div>
  <div class="wrap">
    <div class="quiz-col">
      <button class="btn" onclick="playClick(); start('fem')">Jogar como Feminino</button>
      <button class="btn" onclick="playClick(); start('masc')">Jogar como Masculino</button>
    </div>
  </div>
</section>

<!-- QUIZ -->
<section id="quiz" class="screen">
  <div id="bg-quiz" class="bg"></div>
  <div class="wrap">
    <div class="quiz-col">
      <div id="quiz-head" class="quiz-head">
        Segure firme: seu diagn√≥stico empreendedor come√ßa agora!
        <span class="accent">In√≠cio</span>
      </div>
      <div class="quiz-card">
        <div class="quiz-top">
          <div style="height:1px"></div>
          <div id="q-counter" class="counter">1/15</div>
        </div>
        <div id="qtext"></div>
        <div id="opts"></div>
      </div>
    </div>
  </div>
</section>

<!-- RESULTADO -->
<section id="result" class="screen">
  <div class="bg" id="bg-result"></div>
  <div class="wrap">
    <div class="quiz-card" style="margin-bottom:22px;">
      <h2 id="r-title"></h2>
      <p id="r-desc"></p>
      <ul id="r-actions" class="actions"></ul>
      <p style="margin-top:12px;color:#666;font-size:12px" id="wm"></p>
    </div>
    <div class="btn-row">
      <button id="r-course" class="btn-cta"></button>
      <button class="btn-secondary" onclick="playClick(); go('cover')">üîÑ Recome√ßar o jogo</button>
    </div>
  </div>
</section>

<footer>
  <a href="/terms.html" target="_blank" rel="noopener">Termos de Uso</a> ¬∑
  <a href="/privacy.html" target="_blank" rel="noopener">Pol√≠tica de Privacidade</a>
</footer>

<!-- √ÅUDIO -->
<audio id="snd-click" src="sounds/click.mp3" preload="auto" playsinline></audio>
<audio id="snd-win" src="sounds/win.mp3" preload="auto" playsinline></audio>

<script>
/* -------- Lock de dom√≠nio -------- */
(function(){
  const allowed = 'https://labnivel.netlify.app';
  if (location.origin !== allowed && location.protocol !== 'file:') {
    location.replace(allowed);
  }
})();

/* -------- Navega√ß√£o -------- */
function go(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
  document.getElementById(id).classList.add('show');
}

/* -------- Token gating -------- */
let isAuthorized = false, currentToken = '';
async function validarAcessoSeHouverToken() {
  const token = new URLSearchParams(location.search).get("token");
  const localDev = location.protocol === 'file:' || location.hostname === 'localhost';
  if (localDev) { isAuthorized = true; return; }
  if (!token) { isAuthorized = false; return; }
  try {
    const r = await fetch(`/.netlify/functions/validate-token?token=${encodeURIComponent(token)}`, {cache:'no-store'});
    const d = await r.json();
    isAuthorized = !!(d && d.valido);
    if (isAuthorized) currentToken = token;
  } catch { isAuthorized = false; }
}
function gateOr(fn){ return (...a)=> isAuthorized ? fn(...a) : (alert("Acesso restrito. Ative o jogo na Introdu√ß√£o e volte com o link de acesso."), go('intro')); }

/* -------- √Åudio -------- */
const clickSound=document.getElementById('snd-click');
const winSound=document.getElementById('snd-win');
function playClick(){ try{ clickSound.currentTime=0; clickSound.play(); }catch(e){} }
function playWin(){ try{ winSound.currentTime=0; winSound.play(); }catch(e){} }
let audioUnlocked=false;
function unlockAudio(){
  if(audioUnlocked) return;
  [clickSound,winSound].forEach(a=>{ try{ a.muted=true; a.play().then(()=>{a.pause();a.currentTime=0;a.muted=false;}).catch(()=>{});}catch(e){} });
  audioUnlocked=true;
}
document.addEventListener('touchstart',unlockAudio,{passive:true,once:true});
document.addEventListener('pointerdown',unlockAudio,{passive:true,once:true});

/* -------- Perguntas (V2) com pesos salteados -------- */
const QUESTIONS = [
  { q:"Voc√™ j√° possui um plano de neg√≥cios estruturado?",
    a:["Rascunho em andamento, usamos como refer√™ncia quando necess√°rio","Sim, completo, revisado e usado nas decis√µes","Ainda n√£o; organizo a ideia em anota√ß√µes soltas","Vers√£o enxuta com metas e or√ßamento b√°sico, atualizada √†s vezes"],
    w:[2,4,1,3]
  },
  { q:"Sua empresa tem metas claras e mensur√°veis para os pr√≥ximos meses?",
    a:["N√£o formalizamos metas; trabalhamos no que aparece","Acompanhamos OKRs/SMART com rituais de revis√£o","Metas b√°sicas mensais (faturamento/clientes), revis√£o ocasional","Metas SMART por √°rea, revisadas com indicadores semanais"],
    w:[1,3,2,4]
  },
  { q:"Voc√™ separa as finan√ßas pessoais das empresariais?",
    a:["Separo e tenho DRE/or√ßamento; concilio tudo todo m√™s","Ainda misturo; estou organizando aos poucos","Separo, mas √†s vezes me atrapalho; uso planilha simples","Separa√ß√£o total com controles e automa√ß√µes financeiras"],
    w:[3,1,2,4]
  },
  { q:"Costuma tomar decis√µes mais na intui√ß√£o ou em dados?",
    a:["Intui√ß√£o com valida√ß√µes pontuais (pesquisas r√°pidas, testes)","Maior parte na intui√ß√£o; raramente registro dados","Decis√µes orientadas por pain√©is/KPIs e experimentos","Combino dados b√°sicos (planilhas/CRM) com a experi√™ncia pr√°tica"],
    w:[2,1,4,3]
  },
  { q:"J√° buscou consultoria ou mentoria para apoiar sua gest√£o?",
    a:["Mentoria recorrente e programas de acelera√ß√£o","Sess√µes pontuais quando surge um desafio espec√≠fico","Nunca busquei; aprendo sozinho(a) e com a equipe","Mentoria estruturada + acompanhamento com plano de a√ß√£o"],
    w:[4,2,1,3]
  },
  { q:"Seu neg√≥cio tem uma rotina organizada (processos definidos, controles de estoque, fluxo de caixa)?",
    a:["Processos b√°sicos e alguns checklists em uso","Processos padronizados, indicadores e auditorias internas","Rotina definida, controles em planilhas/ERP simples","Processos mapeados e revisados com melhoria cont√≠nua"],
    w:[1,4,2,3]
  },
  { q:"Voc√™ j√° possui colaboradores ou parceiros fixos na opera√ß√£o?",
    a:["Aut√¥nomos/terceiros de confian√ßa para demandas recorrentes","Equipe pequena com pap√©is definidos e ritos semanais","Equipe estabelecida com l√≠deres e metas por √°rea","Toco praticamente tudo sozinho(a) no dia a dia"],
    w:[2,3,4,1]
  },
  { q:"Sua equipe ou fornecedores sabem exatamente seus pap√©is no neg√≥cio?",
    a:["Pap√©is definidos por escrito e metas por fun√ß√£o","Pap√©is informais; alinhamos no dia a dia","Estrutura com organograma, SLAs e indicadores de desempenho","Ainda n√£o formalizamos; cada um ajuda onde d√°"],
    w:[3,2,4,1]
  },
  { q:"Voc√™ revisa com frequ√™ncia os resultados financeiros e ajusta estrat√©gias?",
    a:["Acompanho mensalmente e fa√ßo ajustes b√°sicos","Revis√£o semanal com KPIs e plano de a√ß√£o por alavancas","Revis√£o trimestral e ajustes quando necess√°rio","Quase n√£o reviso; foco na opera√ß√£o do dia a dia"],
    w:[2,4,3,1]
  },
  { q:"Sua empresa investe em inova√ß√£o ou melhorias cont√≠nuas (novos produtos, tecnologias, treinamentos)?",
    a:["Raramente; quando sobra tempo/or√ßamento","Alguns testes e cursos pontuais por trimestre","Roadmap de melhorias com metas e respons√°veis","Pipeline de inova√ß√£o com experimentos e m√©tricas de sucesso"],
    w:[1,2,3,4]
  },
  { q:"Voc√™ tem uma estrat√©gia de marketing clara para atrair clientes?",
    a:["Plano multicanal com m√©tricas de CAC/LTV e automa√ß√µes","Dependemos de indica√ß√£o e redes sociais espor√°dicas","Calend√°rio de conte√∫do + campanhas pontuais","A√ß√µes de base (Google/Instagram) com acompanhamento simples"],
    w:[4,1,3,2]
  },
  { q:"J√° conquistou uma base de clientes recorrentes e satisfeitos?",
    a:["Base fiel com programas de reten√ß√£o e NPS alto","Alguns clientes voltam; melhoramos a experi√™ncia aos poucos","Temos recorr√™ncia em linhas espec√≠ficas","Ainda √© inst√°vel; varia m√™s a m√™s"],
    w:[1,3,4,2]
  },
  { q:"Quando surge um problema, voc√™ tende a apagar inc√™ndios ou j√° tem um plano de conting√™ncia?",
    a:["Resolvemos r√°pido, mas sem padroniza√ß√£o","Muitas vezes viramos a noite apagando inc√™ndios","Planos de conting√™ncia documentados e treinados","Playbook de incidentes com respons√°veis e comunica√ß√£o clara"],
    w:[2,1,3,4]
  },
  { q:"Voc√™ dedica parte do seu tempo a pensar em expans√£o ou novos mercados?",
    a:["Exploramos oportunidades com metas e pesquisas formais","Plano de expans√£o com cronograma e budget","Penso nisso quando sobra tempo","Estudo ideias e fa√ßo testes menores para validar"],
    w:[3,4,1,2]
  },
  { q:"Se voc√™ se ausentar por alguns dias, o neg√≥cio continua funcionando sem parar?",
    a:["Sim, por semanas: processos e l√≠deres tocam a opera√ß√£o","Sim, por alguns dias com pequenas depend√™ncias","Parcialmente; preciso estar por perto para decidir pontos-chave","Ainda n√£o; a opera√ß√£o depende muito de mim"],
    w:[4,2,3,1]
  }
];

const RESULTS={
  1:{title:"N√≠vel 1 ‚Äì Aventureiro üöÄ",
     desc:"Parab√©ns pela coragem de dar o primeiro passo! Voc√™, assim como eu, j√° saiu da ideia e partiu para a a√ß√£o. Agora √© hora de transformar entusiasmo em estrat√©gia para construir uma base s√≥lida e sustent√°vel para o seu neg√≥cio.",
     actions:["Buscar apoio cont√°bil e financeiro b√°sico.","Fazer um curso introdut√≥rio de gest√£o.","Criar um plano de neg√≥cios simples.","Separar finan√ßas pessoais das empresariais."],
     avatarF:"nivel1-fem.png", avatarM:"nivel1-masc.png", course:"Ative o Laborat√≥rio 2.0"},
  2:{title:"N√≠vel 2 ‚Äì Estrategista üìä",
     desc:"Voc√™ j√° pensa e age como um verdadeiro estrategista! Seu neg√≥cio demonstra organiza√ß√£o e vis√£o de crescimento. Agora √© hora de fortalecer sua estrat√©gia e desenvolver lideran√ßa para conquistar novos mercados.",
     actions:["Participar de mentorias com empres√°rios experientes.","Investir em marketing estruturado e automa√ß√£o.","Acompanhar indicadores financeiros regularmente.","Desenvolver habilidades de lideran√ßa."],
     avatarF:"nivel2-fem.png", avatarM:"nivel2-masc.png", course:"Ative o Laborat√≥rio 3.0"},
  3:{title:"N√≠vel 3 ‚Äì L√≠der üèÜ",
     desc:"Voc√™ alcan√ßou a posi√ß√£o de l√≠der! Sua vis√£o inspira sua equipe e o mercado. Agora o desafio √© inovar, expandir e preparar sucessores para perpetuar o legado da sua empresa.",
     actions:["Investir em inova√ß√£o e tecnologia.","Expandir para novos mercados.","Formar e capacitar l√≠deres internos.","Criar planos de sucess√£o e governan√ßa corporativa."],
     avatarF:"nivel3-fem.png", avatarM:"nivel3-masc.png", course:"Ative o Laborat√≥rio 4.0"}
};

/* -------- Estado e navega√ß√£o -------- */
let state={idx:0,score:0,gender:"masc"};
function go(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show')); document.getElementById(id).classList.add('show'); }
let start = gateOr(function(g){ state.gender=g;state.idx=0;state.score=0; renderQ(); go('quiz'); });

/* -------- Renderiza√ß√£o do quiz -------- */
function renderQ(){
  if(state.idx>=QUESTIONS.length){finish();return;}
  let fundo="images/fundo1.png";
  if(state.idx>=5 && state.idx<10) fundo="images/fundo2.png";
  if(state.idx>=10) fundo="images/fundo3.png";
  document.getElementById('bg-quiz').style.backgroundImage="url('"+fundo+"')";
  document.getElementById('q-counter').textContent=(state.idx+1)+"/"+QUESTIONS.length;
  document.getElementById('quiz-head').style.display=(state.idx===0)?'block':'none';
  const q=QUESTIONS[state.idx];
  document.getElementById('qtext').textContent=q.q;
  const opts=document.getElementById('opts'); opts.innerHTML="";
  q.a.forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='opt'; b.textContent=t;
    b.onclick=()=>{ playClick(); state.score += (q.w ? q.w[i] : (i+1)); state.idx++; renderQ(); };
    opts.appendChild(b);
  });
}

/* -------- Utilidades -------- */
function maskEmail(e){ if(!e) return ''; const [u,d]=e.split('@'); return (u?.slice(0,3)||'')+'***@'+(d||''); }

/* -------- Final -------- */
function finish(){
  let lvl = 1;
  if(state.score > 45) lvl = 3;
  else if(state.score > 27) lvl = 2;
  const res=RESULTS[lvl];

  // watermark com e-mail do token (se existir)
  const t = currentToken;
  let email = '';
  try{
    if(t){ const payload = JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); email = payload.email || ''; }
  }catch(e){}

  document.getElementById('r-title').textContent=res.title;
  document.getElementById('r-desc').textContent=res.desc;
  const ul=document.getElementById('r-actions'); ul.innerHTML="";
  res.actions.forEach(a=>{const li=document.createElement('li'); li.textContent="üîπ "+a; ul.appendChild(li);});
  document.getElementById('wm').textContent = email ? ('Acesso: '+maskEmail(email)) : '';

  /* Avatares via assets protegidos (coloque os PNGs em /protected/) */
  const avatar = (state.gender==='fem')?res.avatarF:res.avatarM;
  const bg = "/.netlify/functions/assets?file="+encodeURIComponent(avatar)+"&token="+encodeURIComponent(currentToken);
  document.getElementById('bg-result').style.backgroundImage="url('"+bg+"')";

  const rc=document.getElementById('r-course'); rc.textContent=res.course;
  rc.onclick = ()=>{ window.open('https://bit.ly/eva_acontabil', '_blank'); };
  playWin(); go('result');
}

/* -------- Inicializa√ß√£o -------- */
document.addEventListener('DOMContentLoaded', validarAcessoSeHouverToken);

/* -------- INTRO: abre checkout em nova aba; ESTA aba vai para /acesso.html -------- */
function payAndValidate(url){
  try{
    const u = new URL(url);
    const pref =
      u.searchParams.get('pref_id') ||
      u.searchParams.get('preference_id') ||
      u.searchParams.get('preference-id');

    if (pref) localStorage.setItem('mp_pref_id', pref);

    // Abre SOMENTE o checkout do MP em nova aba
    window.open(url, '_blank', 'noopener');

    // E leva ESTA aba para /acesso.html com o preference_id (se houver)
    const q = pref ? ('?preference_id=' + encodeURIComponent(pref)) : '';
    window.location.href = '/acesso.html' + q;
  }catch(e){
    // fallback: mesmo que a URL quebre, deixa o usu√°rio pagar e depois volta manualmente
    window.open(url, '_blank', 'noopener');
    window.location.href = '/acesso.html';
  }
  return false; // evita navega√ß√£o padr√£o
}
</script>

</body>
</html>
