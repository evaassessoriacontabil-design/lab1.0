<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>LaboratÃ³rio ContÃ¡bil â€” v6.12 Premium</title>

<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#0a0a0a;color:#fff;font-family:Arial,system-ui,-apple-system}
.screen{display:none;position:relative;width:100vw;height:100vh;overflow:hidden}
@supports (height:100svh){.screen{height:100svh}}
.show{display:block}
.wrap{position:relative;z-index:2;display:flex;align-items:center;justify-content:flex-end;height:100%;padding:5%}
.bg{position:absolute;inset:0;pointer-events:none;background-position:center;background-repeat:no-repeat;background-size:cover}
@media (max-aspect-ratio:9/16),(min-aspect-ratio:21/9){.bg{background-size:contain;background-color:#000}}
.btn{appearance:none;-webkit-appearance:none;background:#ff2d2d;color:#fff;border:0;border-radius:12px;padding:16px 28px;font-weight:700;font-size:28px;min-width:240px;cursor:pointer;text-decoration:none;display:inline-block;text-align:center}
.btn-secondary{background:#2a2a2a;color:#fff;border:0;border-radius:12px;padding:16px 28px;font-weight:700;font-size:22px;min-width:220px;cursor:pointer}
.btn-cta{background:#ff2d2d;color:#fff;border:0;border-radius:12px;padding:16px 28px;font-weight:700;font-size:22px;min-width:220px;cursor:pointer}
.quiz-card{background:#fff;color:#000;border-radius:14px;padding:22px;max-width:640px;box-shadow:0 8px 22px rgba(0,0,0,.35)}
#quiz .wrap{justify-content:flex-end;align-items:center;padding-right:8%}
.quiz-col{display:flex;flex-direction:column;align-items:flex-end;gap:12px;max-width:720px;width:100%}
.quiz-head{color:#fff;font-weight:900;font-size:clamp(22px,3.4vw,38px);text-align:right;line-height:1.15}
.quiz-head .accent{display:inline-block;background:#ff2d2d;padding:4px 10px;border-radius:999px;font-size:.65em;margin-left:10px;vertical-align:middle}
.quiz-top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px}
.counter{background:#111;color:#fff;padding:6px 10px;border-radius:999px;font-weight:700;font-size:16px;min-width:66px;text-align:center}
#qtext{font-size:clamp(22px,3vw,34px);font-weight:800;margin:12px 0 16px}
.opt{display:block;width:100%;margin:8px 0;padding:14px;background:#eee;border:0;border-radius:10px;text-align:left;font-size:clamp(16px,2vw,20px);cursor:pointer}
#result .wrap{flex-direction:column;justify-content:center;align-items:center;padding:5%}
.actions{text-align:left;margin:16px 0;padding-left:18px}
.actions li{margin:8px 0}
.btn-row{display:flex;gap:20px;margin-top:20px;justify-content:center;flex-wrap:wrap}
#gender .wrap{flex-direction:column;align-items:flex-end;justify-content:center;gap:18px}
footer{position:fixed;left:0;right:0;bottom:6px;text-align:center;font-size:12px;color:#999}
footer a{color:#bbb;text-decoration:none}
footer a:hover{text-decoration:underline}
@media (max-width:480px){
  .btn{font-size:20px;min-width:200px}
  .btn-cta,.btn-secondary{font-size:18px;min-width:180px}
  .quiz-card{max-width:92vw;padding:18px}
  #quiz .wrap{padding-right:4%}
  .quiz-col{max-width:92vw}
}
</style>
</head>
<body>

<!-- CAPA -->
<section id="cover" class="screen show">
  <div class="bg" style="background-image:url('images/capa.png')"></div>
  <div class="wrap" style="align-items:flex-end;justify-content:flex-end">
    <button class="btn" onclick="enterGame()">ðŸŽ® VAMOS JOGAR</button>
  </div>
</section>

<!-- INTRODUÃ‡ÃƒO -->
<section id="intro" class="screen">
  <div class="bg" style="background-image:url('images/intro.png')"></div>
  <div class="wrap" style="align-items:flex-end;justify-content:flex-end">
    <button class="btn" id="ativarBtn" type="button" onclick="return createAndPay(this);">
      ATIVAR JOGO â€“ R$29,90
    </button>
  </div>
</section>

<!-- GÃŠNERO -->
<section id="gender" class="screen">
  <div class="bg" style="background-image:url('images/genero.png')"></div>
  <div class="wrap">
    <div class="quiz-col">
      <button class="btn" onclick="playClick(); start('fem')">Jogar como Feminino</button>
      <button class="btn" onclick="playClick(); start('masc')">Jogar como Masculino</button>
    </div>
  </div>
</section>

<!-- QUIZ -->
<section id="quiz" class="screen">
  <div id="bg-quiz" class="bg"></div>
  <div class="wrap">
    <div class="quiz-col">
      <div id="quiz-head" class="quiz-head">
        Segure firme: seu diagnÃ³stico empreendedor comeÃ§a agora!
        <span class="accent">InÃ­cio</span>
      </div>
      <div class="quiz-card">
        <div class="quiz-top">
          <div style="height:1px"></div>
          <div id="q-counter" class="counter">1/15</div>
        </div>
        <div id="qtext"></div>
        <div id="opts"></div>
      </div>
    </div>
  </div>
</section>

<!-- RESULTADO -->
<section id="result" class="screen">
  <div class="bg" id="bg-result"></div>
  <div class="wrap">
    <div class="quiz-card" style="margin-bottom:22px;">
      <h2 id="r-title"></h2>
      <p id="r-desc"></p>
      <ul id="r-actions" class="actions"></ul>
      <p style="margin-top:12px;color:#666;font-size:12px" id="wm"></p>
    </div>
    <div class="btn-row">
      <button id="r-course" class="btn-cta"></button>
      <button class="btn-secondary" onclick="playClick(); go('cover')">ðŸ”„ RecomeÃ§ar o jogo</button>
    </div>
  </div>
</section>

<footer>
  <a href="/terms.html" target="_blank" rel="noopener">Termos de Uso</a> Â·
  <a href="/privacy.html" target="_blank" rel="noopener">PolÃ­tica de Privacidade</a>
</footer>

<!-- ÃUDIO -->
<audio id="snd-click" src="sounds/click.mp3" preload="auto" playsinline></audio>
<audio id="snd-win" src="sounds/win.mp3" preload="auto" playsinline></audio>

<script>
/* Lock de domÃ­nio */
(function(){
  const allowed='https://labnivel.netlify.app';
  if(location.origin!==allowed && location.protocol!=='file:'){ location.replace(allowed); }
})();

/* NavegaÃ§Ã£o bÃ¡sica */
function go(id){
  if(id==='intro' && isAuthorized) id='gender';
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
  document.getElementById(id).classList.add('show');
}

/* Entrar respeitando o acesso */
function enterGame(){
  playClick();
  if(isAuthorized) go('gender');
  else go('intro');
}

/* Ajustes de interface quando liberado */
function updateUIAuthorized(){
  const btn=document.getElementById('ativarBtn');
  if(btn) btn.style.display=isAuthorized?'none':'';
  const introShown=document.getElementById('intro')?.classList.contains('show');
  if(isAuthorized && introShown) go('gender');
}

/* Token gating */
let isAuthorized=false, currentToken='';
async function validarAcessoSeHouverToken(){
  const token=new URLSearchParams(location.search).get("token");
  const localDev=(location.protocol==='file:'||location.hostname==='localhost');
  if(localDev){ isAuthorized=true; updateUIAuthorized(); return; }
  if(!token){ isAuthorized=false; updateUIAuthorized(); return; }
  try{
    const r=await fetch(`/.netlify/functions/validate-token?token=${encodeURIComponent(token)}`,{cache:'no-store'});
    const d=await r.json();
    isAuthorized=!!(d&&d.valido);
    if(isAuthorized) currentToken=token;
  }catch{ isAuthorized=false; }
  updateUIAuthorized();
}

/* Ãudio */
const clickSound=document.getElementById('snd-click');
const winSound=document.getElementById('snd-win');
function playClick(){try{clickSound.currentTime=0;clickSound.play();}catch(e){}}
function playWin(){try{winSound.currentTime=0;winSound.play();}catch(e){}}
let audioUnlocked=false;
function unlockAudio(){
  if(audioUnlocked) return;
  [clickSound,winSound].forEach(a=>{
    try{a.muted=true;a.play().then(()=>{a.pause();a.currentTime=0;a.muted=false;}).catch(()=>{})}catch(e){}
  });
  audioUnlocked=true;
}
document.addEventListener('touchstart',unlockAudio,{passive:true,once:true});
document.addEventListener('pointerdown',unlockAudio,{passive:true,once:true});

/* Quiz */
const QUESTIONS=[ /* ... (mantÃ©m suas perguntas originais) ... */ ];
const RESULTS={ /* ... (mantÃ©m seus resultados originais) ... */ };

let state={idx:0,score:0,gender:"masc"};
function start(g){ gateOr(()=>{state.gender=g;state.idx=0;state.score=0;renderQ();go('quiz');})(); }
function renderQ(){ if(state.idx>=QUESTIONS.length){finish();return;}
 let fundo="images/fundo1.png"; if(state.idx>=5&&state.idx<10)fundo="images/fundo2.png"; if(state.idx>=10)fundo="images/fundo3.png";
 document.getElementById('bg-quiz').style.backgroundImage="url('"+fundo+"')";
 document.getElementById('q-counter').textContent=(state.idx+1)+"/"+QUESTIONS.length;
 document.getElementById('quiz-head').style.display=(state.idx===0)?'block':'none';
 const q=QUESTIONS[state.idx];
 document.getElementById('qtext').textContent=q.q;
 const opts=document.getElementById('opts'); opts.innerHTML="";
 q.a.forEach((t,i)=>{const b=document.createElement('button');b.className='opt';b.textContent=t;b.onclick=()=>{playClick();state.score+=(q.w?q.w[i]:(i+1));state.idx++;renderQ();};opts.appendChild(b);});
}

function maskEmail(e){if(!e)return'';const[u,d]=e.split('@');return(u?.slice(0,3)||'')+'***@'+(d||'');}
function finish(){
 let lvl=1;if(state.score>45)lvl=3;else if(state.score>27)lvl=2;
 const res=RESULTS[lvl];
 let email='';try{if(currentToken){const p=JSON.parse(atob(currentToken.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));email=p.email||'';}}catch(e){}
 document.getElementById('r-title').textContent=res.title;
 document.getElementById('r-desc').textContent=res.desc;
 const ul=document.getElementById('r-actions');ul.innerHTML="";res.actions.forEach(a=>{const li=document.createElement('li');li.textContent="ðŸ”¹ "+a;ul.appendChild(li);});
 document.getElementById('wm').textContent=email?('Acesso: '+maskEmail(email)):'';
 const avatar=(state.gender==='fem')?res.avatarF:res.avatarM;
 const bg="/.netlify/functions/assets?file="+encodeURIComponent(avatar)+"&token="+encodeURIComponent(currentToken);
 document.getElementById('bg-result').style.backgroundImage="url('"+bg+"')";
 const rc=document.getElementById('r-course');rc.textContent=res.course;rc.onclick=()=>{window.open('https://bit.ly/eva_acontabil','_blank');};
 playWin();go('result');
}

function gateOr(fn){return(...a)=>isAuthorized?fn(...a):(alert("Acesso restrito. Ative o jogo na IntroduÃ§Ã£o e volte com o link de acesso."),go('intro'));}

async function createAndPay(btn){
 try{
  btn.disabled=true;playClick();
  const r=await fetch('/.netlify/functions/mp-create-preference',{method:'POST'});
  const data=await r.json();
  if(!r.ok||!data.ok||!data.init_point||!data.preference_id){alert('NÃ£o foi possÃ­vel iniciar o pagamento.');btn.disabled=false;return false;}
  const pref=data.preference_id,init=data.init_point;
  try{localStorage.setItem('mp_pref_id',pref);}catch(e){}
  const a=document.createElement('a');a.href=init;a.target='_blank';a.rel='noopener';document.body.appendChild(a);a.click();document.body.removeChild(a);
  window.location.href='/acesso.html?preference_id='+encodeURIComponent(pref);
  return false;
 }catch(e){alert('Erro ao iniciar pagamento.');btn.disabled=false;return false;}
}

document.addEventListener('DOMContentLoaded',validarAcessoSeHouverToken);
</script>

</body>
</html>
