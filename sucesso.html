<script>
(async ()=>{
  const qs = new URLSearchParams(location.search);
  const payment_id = qs.get("payment_id") || qs.get("collection_id");
  if (!payment_id) {
    alert("Pagamento não identificado.");
    location.replace("/");
    return;
  }

  try {
    const resp = await fetch(`/.netlify/functions/check-access?payment_id=${encodeURIComponent(payment_id)}`);
    const data = await resp.json();

    if (data.ok) {
      localStorage.setItem("labnivel_paid", JSON.stringify({ ok: true, at: Date.now() }));
      // se abriu em nova aba, tenta fechar depois
      setTimeout(()=>{ try{ window.close(); }catch(_){} }, 1200);
      location.replace("/acesso.html");
    } else {
      document.body.innerHTML = `
        <h2>Pagamento não aprovado</h2>
        <p>Status: ${data.status || "desconhecido"}</p>
        <p><a href="/">Voltar</a></p>`;
    }
  } catch (e) {
    document.body.innerHTML = `
      <h2>Erro ao validar</h2>
      <pre>${String(e).slice(0,200)}</pre>
      <p><a href="/">Voltar</a></p>`;
  }
})();
</script>
