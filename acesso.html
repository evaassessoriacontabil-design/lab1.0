<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Validando pagamento…</title>
  <style>
    body{margin:0;height:100vh;display:grid;place-items:center;background:#0a0a0a;color:#fff;font-family:system-ui,Arial}
    .box{max-width:620px;text-align:center;padding:0 16px}
    .spin{width:40px;height:40px;border:4px solid #444;border-top-color:#ff2d2d;border-radius:50%;margin:16px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{color:#bbb;font-size:14px;margin-top:10px}
    .btn{background:#ff2d2d;color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="box">
    <h1>Validando seu pagamento…</h1>
    <div class="spin"></div>
    <p>Isso leva só alguns segundos. Você será redirecionada automaticamente.</p>
    <p class="hint" id="status"></p>
    <button class="btn" id="forcar" style="display:none">Liberar acesso</button>
  </div>

  <script>
  (function(){
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('forcar');

    // Monta a URL para claim-access usando:
    // 1) payment_id/collection_id enviados pelo MP
    // 2) preference_id/pref_id enviados pelo MP
    // 3) Fallback: preference_id salvo no localStorage quando o usuário clicou no botão da INTRO
    function makeClaimUrl(){
      const qs = new URLSearchParams(location.search);
      const site = location.origin || 'https://labnivel.netlify.app';
      const base = site + '/.netlify/functions/claim-access';

      // tenta pegar direto da URL
      const payment_id   = qs.get('payment_id') || qs.get('collection_id') || qs.get('id') || qs.get('data.id');
      const prefFromUrl  = qs.get('preference_id') || qs.get('pref_id');
      const prefFromLS   = localStorage.getItem('mp_pref_id');

      if (payment_id) {
        return base + '?payment_id=' + encodeURIComponent(payment_id);
      }
      if (prefFromUrl) {
        return base + '?preference_id=' + encodeURIComponent(prefFromUrl);
      }
      if (prefFromLS) {
        return base + '?preference_id=' + encodeURIComponent(prefFromLS);
      }
      return base; // sem parâmetros: a função vai retornar ao index com um aviso
    }

    async function tryClaim(){
      const url = makeClaimUrl();
      statusEl.textContent = 'Contactando servidor…';
      try {
        // redirecionamento 302 será seguido automaticamente pelo navegador
        location.replace(url);
      } catch(e){
        statusEl.textContent = 'Falha ao validar. Você pode tentar novamente.';
        btn.style.display = 'inline-block';
      }
    }

    // Botão manual caso algo impeça o redirect automático
    btn.addEventListener('click', tryClaim);

    // dispara automaticamente
    tryClaim();

    // Se nada acontecer em 8s, mostra o botão manual
    setTimeout(()=>{ btn.style.display='inline-block'; }, 8000);
  })();
  </script>
</body>
</html>
