<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Validando pagamento…</title>
  <style>
    body{margin:0;height:100vh;display:grid;place-items:center;background:#0a0a0a;color:#fff;font-family:system-ui,Arial}
    .box{max-width:620px;text-align:center;padding:0 16px}
    .spin{width:40px;height:40px;border:4px solid #444;border-top-color:#ff2d2d;border-radius:50%;margin:16px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{color:#bbb;font-size:14px;margin-top:10px}
    .btn{background:#ff2d2d;color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="box">
    <h1>Validando seu pagamento…</h1>
    <div class="spin"></div>
    <p>Isso leva só alguns segundos. Você será redirecionada automaticamente.</p>
    <p class="hint" id="status"></p>
    <button class="btn" id="forcar" style="display:none">Liberar acesso agora</button>
  </div>

  <script>
  (function(){
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('forcar');

    function getPrefFromAnywhere(){
      const qs = new URLSearchParams(location.search);
      const payment_id = qs.get('payment_id') || qs.get('collection_id') || qs.get('id') || qs.get('data.id');
      // lê também o formato "preference-id" (com hífen)
      const prefUrl   = qs.get('preference_id') || qs.get('pref_id') || qs.get('preference-id');
      const prefLS    = localStorage.getItem('mp_pref_id');
      return { payment_id, preference_id: prefUrl || prefLS || '' };
    }

    async function checkOnce(){
      const {payment_id, preference_id} = getPrefFromAnywhere();
      const p = new URLSearchParams();
      if (payment_id) p.set('payment_id', payment_id);
      if (!payment_id && preference_id) p.set('preference_id', preference_id);

      const url = '/.netlify/functions/check-access?' + p.toString();
      statusEl.textContent = 'Consultando status…';
      try{
        const r = await fetch(url, { cache:'no-store' });
        const data = await r.json();
        if (data.ok && data.link){
          location.replace(data.link); // jogo liberado
          return true;
        }else{
          statusEl.textContent = 'Pagamento: ' + (data.status || 'aguardando');
          return false;
        }
      }catch(e){
        statusEl.textContent = 'Falha na consulta. Tentaremos de novo.';
        return false;
      }
    }

    async function startPolling(){
      if (await checkOnce()) return;           // primeira tentativa
      let tries = 0;
      const tm = setInterval(async ()=>{
        tries++;
        const ok = await checkOnce();
        if (ok || tries >= 24){                // 24 * 5s ≈ 2 minutos
          clearInterval(tm);
          btn.style.display = ok ? 'none' : 'inline-block';
          if (!ok) statusEl.textContent = 'Ainda pendente. Você pode tentar de novo pelo botão.';
        }
      }, 5000);
    }

    btn.addEventListener('click', startPolling);
    startPolling();
  })();
  </script>
</body>
</html>
